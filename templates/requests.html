<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Requests</title>
  <link href="/static/bootstrap.min.css" rel="stylesheet">
  <link href="/static/images/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container mt-4">
  <h2 class="mb-4">Requests</h2>

  <!-- Search and Add Button Row -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <form class="d-flex" method="GET" action="/requests">
      <input class="form-control me-2" type="search" name="search" placeholder="Search..." value="{{ request.args.get('search', '') }}">
      <button class="btn btn-outline-secondary" type="submit">
        <i class="bi bi-search"></i>
      </button>
    </form>
    {% if session['role'] in ['admin', 'manager', 'supervisor'] %}
    <a href="#" class="btn btn-primary" onclick="showForm('add')">
      <i class="bi bi-plus-circle"></i> Add
    </a>
    {% endif %}
  </div>

  <!-- Requests Table -->
  <table class="table table-bordered">
    <thead class="table-dark">
      <tr>
        <th>Request ID</th>
        <th>Booking ID</th>
        <th>Request Type</th>
        <th>Quantity</th>
        <th>Unit Cost</th>
        <th>Total Cost</th>
        <th>Status</th>
        <th>Request Time</th>
        <th>Assigned To</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for request in requests %}
      <tr>
        <td>{{ request.request_id }}</td>
        <td>{{ request.booking_id }}</td>
        <td>
          {% if request.item %} {{ request.item }} (Service)
          {% elif request.food_name %} {{ request.food_name }} (Food)
          {% else %} Unknown
          {% endif %}
        </td>
        <td>{{ request.quantity }}</td>
        <td style="text-align: right;">{{ "{:,.2f}".format(request.unitCost | float) }}</td>
        <td style="text-align: right;">{{ "{:,.2f}".format(request.totalCost | float) }}</td>
        <td>{{ request.status|capitalize }}</td>
        <td>{{ request.request_time }}</td>
        <td>
          {% if request.first_name %}
            <span class="badge bg-info text-dark">Assigned to: {{ request.first_name }} {{ request.last_name }}</span>
          {% else %}
            <span class="text-muted">Unassigned</span>
          {% endif %}
        </td>
        <td>
          {% if session['role'] in ['admin', 'manager', 'supervisor'] %}
            <a href="#" class="btn btn-warning btn-sm" onclick="showForm('edit', '{{ request.request_id }}')">
              <i class="bi bi-pencil-square"></i>
            </a>
            <a href="#" class="btn btn-danger btn-sm" onclick="confirmDelete('{{ request.request_id }}')">
              <i class="bi bi-trash-fill"></i>
            </a>
          {% endif %}
          {% if request.status != "completed"%}
          <form action="{{ url_for('assigntask') }}" method="POST" style="display:inline;" class="d-inline-flex align-items-center gap-1 mt-1">
            <input type="hidden" name="assignTask_request_id" value="{{ request.request_id }}">
            <select name="assignTask_staff_id" class="form-select form-select-sm" style="width:auto;" required>
              <option value="">Assign Staff</option>
              {% for staff in staff_list %}
                <option value="{{ staff.staff_id }}" {% if staff.staff_id == request.staff_id %}selected{% endif %}>
                  {{ staff.first_name }} {{ staff.last_name }}
                </option>
              {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary btn-sm px-2 py-1">Assign</button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Back -->
  <a href="/dashboard" class="btn btn-secondary mt-3">‚Üê Back to Homepage</a>

  <!-- Add Request Form -->
  <form id="addForm" action="/addRequest" method="POST" style="display: none;" class="mt-3">
    <div class="mb-3">
      <label for="booking_id" class="form-label">Booking ID:</label>
      <select class="form-control" id="booking_id" name="booking_id" required>
        {% for booking in booking_list %}
        <option value="{{ booking.booking_id}}">Booking {{ booking.booking_id}} (Room {{booking.room_number}})</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Request Type:</label>
      <select class="form-control" id="request_type" onchange="toggleRequestType()" required>
        <option value="service">Service</option>
        <option value="food">Food</option>
      </select>
    </div>

    <div class="mb-3" id="service_div">
      <label for="service_id" class="form-label">Service:</label>
      <select class="form-control" id="service_id" name="service_id">
        {% for service in service_list %}
        <option value="{{ service.service_id }}">{{ service.item }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3" id="food_div" style="display:none;">
      <label for="item_id" class="form-label">Food Item:</label>
      <select class="form-control" id="item_id" name="item_id">
        {% for item in item_list %}
        <option value="{{ item.item_id }}">{{ item.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label for="quantity" class="form-label">Quantity:</label>
      <input type="number" class="form-control" id="quantity" name="quantity" value="1" min="1" required>
    </div>
    <div class="mb-3">
      <label for="unitCost" class="form-label">Unit Cost:</label>
      <input type="text" class="form-control" id="unitCost" name="unitCost" readonly>
    </div>
    <div class="mb-3">
      <label for="status" class="form-label">Status:</label>
      <select class="form-control" id="status" name="status" required>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="completed">Completed</option>
      </select>
    </div>
    <div class="mb-3">
      <label for="request_time" class="form-label">Request Time:</label>
      <input type="datetime-local" class="form-control" id="request_time" name="request_time" required>
    </div>
    <button type="button" class="btn btn-secondary" onclick="hideForm()">Cancel</button>
    <button type="submit" class="btn btn-success">Submit</button>
  </form>

  <!-- Edit Request Form -->
  <form id="editForm" action="/updateRequest" method="POST" style="display: none;" class="mb-4 mt-3">
    <input type="hidden" id="edit_request_id" name="edit_request_id">

    <div class="mb-3">
      <label for="edit_booking_id" class="form-label">Booking ID:</label>
      <select class="form-control" id="edit_booking_id" name="edit_booking_id" required>
        {% for booking in booking_list %}
        <option value="{{ booking.booking_id}}">Booking {{ booking.booking_id}} (Room {{booking.room_number}})</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Request Type:</label>
      <select class="form-control" id="edit_request_type" name="edit_request_type" onchange="toggleEditRequestType()" required>
        <option value="service">Service</option>
        <option value="food">Food</option>
      </select>
    </div>

    <div class="mb-3" id="edit_service_div">
      <label for="edit_service_id" class="form-label">Service:</label>
      <select class="form-control" id="edit_service_id" name="edit_service_id">
        {% for service in service_list %}
        <option value="{{ service.service_id }}">{{ service.item }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3" id="edit_food_div" style="display:none;">
      <label for="edit_item_id" class="form-label">Food Item:</label>
      <select class="form-control" id="edit_item_id" name="edit_item_id">
        {% for item in item_list %}
        <option value="{{ item.item_id }}">{{ item.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label for="edit_quantity" class="form-label">Quantity:</label>
      <input type="number" class="form-control" id="edit_quantity" name="edit_quantity" required>
    </div>
    <div class="mb-3">
      <label for="edit_unitCost" class="form-label">Unit Cost:</label>
      <input type="number" step="0.01" class="form-control" id="edit_unitCost" name="edit_unitCost" readonly>
    </div>
    <div class="mb-3">
      <label for="edit_status" class="form-label">Status:</label>
      <select class="form-control" id="edit_status" name="edit_status" required>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="completed">Completed</option>
      </select>
    </div>
    <div class="mb-3">
      <label for="edit_request_time" class="form-label">Request Time:</label>
      <input type="datetime-local" class="form-control" id="edit_request_time" name="edit_request_time" required>
    </div>

    <button type="button" class="btn btn-secondary" onclick="hideForm()">Cancel</button>
    <button type="submit" class="btn btn-success">Submit</button>
  </form>
</div>

<!-- JS -->
<script>
  const requests = {{ requests | tojson | safe }};

  function toggleRequestType() {
    const type = document.getElementById("request_type").value;
    document.getElementById("service_div").style.display = (type === "service") ? "block" : "none";
    document.getElementById("food_div").style.display = (type === "food") ? "block" : "none";
  }

  function toggleEditRequestType() {
    const type = document.getElementById("edit_request_type").value;
    document.getElementById("edit_service_div").style.display = (type === "service") ? "" : "none";
    document.getElementById("edit_food_div").style.display = (type === "food") ? "" : "none";
    updateEditUnitCost();
  }

  function setDefaultDateTime() {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById("request_time").value = now.toISOString().slice(0,16);
  }

  function showForm(mode, request_id = null) {
    const addForm = document.getElementById("addForm");
    const editForm = document.getElementById("editForm");

    if (mode === "add") {
      addForm.style.display = "block";
      editForm.style.display = "none";
      setDefaultDateTime();
    } else if (mode === "edit") {
      addForm.style.display = "none";
      editForm.style.display = "block";

      const request = requests.find(r => r.request_id == request_id);
      if (request) {
        document.getElementById("edit_request_id").value = request.request_id;
        document.getElementById("edit_booking_id").value = request.booking_id;
        document.getElementById("edit_quantity").value = request.quantity;
        document.getElementById("edit_unitCost").value = request.unitCost;
        document.getElementById("edit_status").value = request.status;
        document.getElementById("edit_request_time").value = new Date(request.request_time).toISOString().slice(0, 16);

        if (request.service_id) {
          document.getElementById("edit_request_type").value = "service";
          toggleEditRequestType();
          document.getElementById("edit_service_id").value = request.service_id;
        } else if (request.item_id) {
          document.getElementById("edit_request_type").value = "food";
          toggleEditRequestType();
          document.getElementById("edit_item_id").value = request.item_id;
        }
      }
    }
  }

  function hideForm() {
    document.getElementById("addForm").style.display = "none";
    document.getElementById("editForm").style.display = "none";
  }

  function confirmDelete(request_id) {
    document.getElementById("modalRequestId").innerText = request_id;
    document.getElementById("confirmDeleteBtn").href = `/deleteRequest/${request_id}`;
    var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
  }
</script>
</body>
</html>